<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>邮箱账号管理后台</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style id="theme-style">
        body {
            background: #f8f9fa;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 250px;
            background: #2c3e50;
            color: white;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid #34495e;
            display: flex;
            align-items: center;
        }
        
        .sidebar-header .logo {
            height: 32px;
            margin-right: 10px;
        }
        
        .sidebar-header h4 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .sidebar-menu {
            padding: 0;
            margin: 0;
            list-style: none;
        }
        
        .sidebar-menu li {
            border-bottom: 1px solid #34495e;
        }
        
        .sidebar-menu a {
            display: block;
            padding: 12px 20px;
            color: #bdc3c7;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: #34495e;
            color: #3498db;
            padding-left: 30px;
        }
        
        .sidebar-menu i {
            margin-right: 10px;
            width: 18px;
        }
        
        /* Main Content Styles */
        .main-content {
            margin-left: 250px;
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        
        .content-header {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .content-header .d-flex {
            align-items: center;
            justify-content: space-between;
        }
        
        .page-content {
            padding: 2rem;
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        /* Card and Table Styles */
        .card { 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: none;
        }
        
        .card-header {
            background: #3498db;
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 1rem 1.5rem;
            font-weight: 600;
        }
        
        .table-striped>tbody>tr:hover { 
            background-color: #f8f9fa; 
            transition: background .2s; 
        }
        
        .welcome { 
            font-size: 1.2rem; 
            font-weight: bold; 
            color: #2c3e50; 
        }
        
        .btn-primary {
            background: #3498db;
            border-color: #3498db;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            border-color: #2980b9;
        }
        
        /* Dark Mode Toggle */
        .btn-darkmode { 
            margin-left: 10px; 
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal.show {
            display: block;
        }
        
        .modal-dialog {
            position: relative;
            width: auto;
            margin: 1.75rem auto;
            max-width: 500px;
        }
        
        .modal-content {
            position: relative;
            display: flex;
            flex-direction: column;
            width: 100%;
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
            border-radius: 0.5rem 0.5rem 0 0;
        }
        
        .modal-body {
            position: relative;
            flex: 1 1 auto;
            padding: 1rem;
        }
        
        .modal-footer {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid #dee2e6;
            border-radius: 0 0 0.5rem 0.5rem;
        }
        
        .btn-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            opacity: 0.5;
        }
        
        .btn-close:hover {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="sidebar-header">
            <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" class="logo" alt="LOGO">
            <h4>管理后台</h4>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" data-section="dashboard" class="nav-link active"><i class="bi bi-house"></i>首页</a></li>
            <li><a href="#" data-section="email-management" class="nav-link"><i class="bi bi-envelope"></i>邮箱管理</a></li>
            <li><a href="#" data-section="card-management" class="nav-link"><i class="bi bi-credit-card"></i>卡密管理</a></li>
            <li><a href="#" data-section="proxy-pool" class="nav-link"><i class="bi bi-globe"></i>代理池</a></li>
            <li><a href="#" data-section="inbox-logs" class="nav-link"><i class="bi bi-list-ul"></i>收件日志</a></li>
            <li><a href="#" data-section="card-logs" class="nav-link"><i class="bi bi-journal-text"></i>卡密日志</a></li>
            <li><a href="#" data-section="system-settings" class="nav-link"><i class="bi bi-gear"></i>系统设置</a></li>
        </ul>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Header -->
        <div class="content-header">
            <div class="d-flex">
                <div>
                    <span class="welcome">欢迎使用邮箱账号管理后台</span>
                </div>
                <div>
                    <span class="me-2 text-success">管理员：{{ username }}</span>
                    <a href="/logout" class="btn btn-outline-secondary btn-sm">退出登录</a>
                    <button type="button" class="btn btn-dark btn-sm btn-darkmode" onclick="toggleDarkMode()">暗色模式</button>
                </div>
            </div>
        </div>

        <!-- Page Content -->
        <div class="page-content">
            {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
            {% endif %}
            {% if success %}
            <div class="alert alert-success">{{ success }}</div>
            {% endif %}

            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <div class="row">
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="bi bi-envelope h2 text-primary"></i>
                                <h5>邮箱账号</h5>
                                <h3 class="text-primary">{{ accounts|length }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="bi bi-credit-card h2 text-success"></i>
                                <h5>卡密总数</h5>
                                <h3 class="text-success">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="bi bi-globe h2 text-info"></i>
                                <h5>代理节点</h5>
                                <h3 class="text-info">{{ proxies|length }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="bi bi-list-ul h2 text-warning"></i>
                                <h5>今日日志</h5>
                                <h3 class="text-warning">0</h3>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-speedometer2"></i> 系统概览
                    </div>
                    <div class="card-body">
                        <p>欢迎使用邮箱账号管理后台系统！</p>
                        <p>您可以通过左侧导航栏访问各种功能模块：</p>
                        <ul>
                            <li><strong>邮箱管理</strong>：管理IMAP邮箱账号，包括添加、删除、测试连接等功能</li>
                            <li><strong>卡密管理</strong>：管理系统卡密（即将推出）</li>
                            <li><strong>代理池</strong>：管理代理服务器池（即将推出）</li>
                            <li><strong>收件日志</strong>：查看邮件收取日志（即将推出）</li>
                            <li><strong>卡密日志</strong>：查看卡密使用日志（即将推出）</li>
                            <li><strong>系统设置</strong>：配置系统参数（即将推出）</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Email Management Section -->
            <div id="email-management" class="content-section">
                <!-- 导入导出操作 -->
                <div class="mb-3">
                    <button type="button" class="btn btn-success me-2" onclick="exportAccounts()">导出账号</button>
                    <div class="d-inline-block me-2">
                        <label class="btn btn-info">
                            导入账号 <input type="file" style="display:none;" accept=".json" onchange="importAccounts(this)">
                        </label>
                    </div>
                    <button type="button" class="btn btn-danger" onclick="deleteSelected()">批量删除</button>
                </div>

                <!-- 添加邮箱账号表单 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-plus-circle"></i> 添加新邮箱账号
                    </div>
                    <div class="card-body">
                        <form method="post" action="/admin">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">备注名称</label>
                                    <input type="text" name="name" class="form-control" placeholder="可选备注名称" value="{{ request.form.name or '' }}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">邮箱地址 *</label>
                                    <input type="email" name="user" class="form-control" placeholder="example@domain.com" required value="{{ request.form.user or '' }}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">邮箱密码 *</label>
                                    <input type="password" name="password" class="form-control" placeholder="邮箱密码或授权码" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">服务器地址 *</label>
                                    <input type="text" name="host" class="form-control" placeholder="mail.example.com" required value="{{ request.form.host or '' }}">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">协议类型 *</label>
                                    <select name="protocol" class="form-select" id="protocol-select" onchange="updatePortSuggestion()">
                                        <option value="IMAP" {{ 'selected' if request.form.protocol == 'IMAP' else '' }}>IMAP</option>
                                        <option value="POP3" {{ 'selected' if request.form.protocol == 'POP3' else '' }}>POP3</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">端口号</label>
                                    <input type="number" name="port" class="form-control" id="port-input" placeholder="自动推荐" value="{{ request.form.port or '' }}">
                                    <div class="form-text" id="port-suggestion">推荐端口: 993</div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">安全连接</label>
                                    <div class="form-check mt-2">
                                        <input type="checkbox" name="ssl" class="form-check-input" id="ssl-checkbox" onchange="updatePortSuggestion()" checked>
                                        <label class="form-check-label" for="ssl-checkbox">
                                            启用 SSL/TLS
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3 d-grid align-self-end">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-plus-circle"></i> 添加账号
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 已添加邮箱账号列表 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-envelope-check"></i> 已添加邮箱账号
                    </div>
                    <div class="card-body">
                        <form id="batch-form" method="post" action="/batch_delete">
                        <table class="table table-striped align-middle">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="check-all" onclick="toggleSelectAll(this)"></th>
                                    <th>备注</th>
                                    <th>邮箱地址</th>
                                    <th>服务器</th>
                                    <th>协议</th>
                                    <th>端口</th>
                                    <th>SSL</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for acc in accounts %}
                                <tr>
                                    <td>
                                        <input type="checkbox" name="selected_users" value="{{ acc.user }}">
                                    </td>
                                    <td>{{ acc.name or '-' }}</td>
                                    <td>{{ acc.user }}</td>
                                    <td>{{ acc.host }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'primary' if acc.get('protocol', 'IMAP') == 'IMAP' else 'info' }}">
                                            {{ acc.get('protocol', 'IMAP') }}
                                        </span>
                                    </td>
                                    <td>{{ acc.get('port', '993' if acc.get('ssl', True) else '143') }}</td>
                                    <td>
                                        {% if acc.get('ssl', True) %}
                                            <i class="bi bi-shield-check text-success" title="SSL启用"></i>
                                        {% else %}
                                            <i class="bi bi-shield-x text-warning" title="SSL未启用"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <form method="post" action="/del_account" style="display:inline;">
                                            <input type="hidden" name="user" value="{{ acc.user }}">
                                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('确认删除该账号？');">删除</button>
                                        </form>
                                        <button type="button" class="btn btn-outline-success btn-sm ms-1" onclick="testAccount('{{ acc.user }}', this)">测试连接</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        </form>
                        {% if accounts|length == 0 %}
                        <div class="text-muted">暂无账号，请先添加。</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Other sections for future features -->
            <div id="card-management" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-credit-card"></i> 卡密管理
                    </div>
                    <div class="card-body">
                        <div class="text-center py-5">
                            <i class="bi bi-credit-card display-1 text-muted"></i>
                            <h4 class="mt-3">卡密管理功能</h4>
                            <p class="text-muted">此功能正在开发中，敬请期待...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="proxy-pool" class="content-section">
                <!-- 代理操作按钮 -->
                <div class="mb-3">
                    <button type="button" class="btn btn-success me-2" onclick="showAddProxyModal()">添加代理</button>
                    <button type="button" class="btn btn-danger" onclick="deleteSelectedProxies()">批量删除</button>
                    <button type="button" class="btn btn-info ms-2" onclick="refreshProxyList()">刷新列表</button>
                </div>

                <!-- 代理列表 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-globe"></i> 代理池管理
                    </div>
                    <div class="card-body">
                        <table class="table table-striped align-middle" id="proxy-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="check-all-proxies" onclick="toggleSelectAllProxies(this)"></th>
                                    <th>名称</th>
                                    <th>类型</th>
                                    <th>地址</th>
                                    <th>端口</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="proxy-list">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">加载中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 添加代理模态框 -->
                <div class="modal fade" id="addProxyModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">添加代理</h5>
                                <button type="button" class="btn-close" onclick="hideAddProxyModal()"></button>
                            </div>
                            <div class="modal-body">
                                <form id="addProxyForm">
                                    <div class="mb-3">
                                        <label for="proxy-name" class="form-label">代理名称</label>
                                        <input type="text" class="form-control" id="proxy-name" name="name" placeholder="可选，默认自动生成">
                                    </div>
                                    <div class="mb-3">
                                        <label for="proxy-type" class="form-label">代理类型 *</label>
                                        <select class="form-select" id="proxy-type" name="type" required>
                                            <option value="">请选择代理类型</option>
                                            <option value="HTTP">HTTP</option>
                                            <option value="HTTPS">HTTPS</option>
                                            <option value="SOCKS4">SOCKS4</option>
                                            <option value="SOCKS5">SOCKS5</option>
                                        </select>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-8">
                                            <label for="proxy-host" class="form-label">代理地址 *</label>
                                            <input type="text" class="form-control" id="proxy-host" name="host" placeholder="127.0.0.1" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="proxy-port" class="form-label">端口 *</label>
                                            <input type="number" class="form-control" id="proxy-port" name="port" placeholder="1080" min="1" max="65535" required>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label for="proxy-username" class="form-label">用户名</label>
                                            <input type="text" class="form-control" id="proxy-username" name="username" placeholder="可选">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="proxy-password" class="form-label">密码</label>
                                            <input type="password" class="form-control" id="proxy-password" name="password" placeholder="可选">
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="hideAddProxyModal()">取消</button>
                                <button type="button" class="btn btn-primary" onclick="addProxy()">添加代理</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="inbox-logs" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-list-ul"></i> 收件日志
                    </div>
                    <div class="card-body">
                        <div class="text-center py-5">
                            <i class="bi bi-list-ul display-1 text-muted"></i>
                            <h4 class="mt-3">收件日志功能</h4>
                            <p class="text-muted">此功能正在开发中，敬请期待...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="card-logs" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-journal-text"></i> 卡密日志
                    </div>
                    <div class="card-body">
                        <div class="text-center py-5">
                            <i class="bi bi-journal-text display-1 text-muted"></i>
                            <h4 class="mt-3">卡密日志功能</h4>
                            <p class="text-muted">此功能正在开发中，敬请期待...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="system-settings" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-gear"></i> 系统设置
                    </div>
                    <div class="card-body">
                        <div class="text-center py-5">
                            <i class="bi bi-gear display-1 text-muted"></i>
                            <h4 class="mt-3">系统设置功能</h4>
                            <p class="text-muted">此功能正在开发中，敬请期待...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="test-result" style="display:none;" class="alert mt-2"></div>
        </div>
    </div>

    <script>
        // Navigation functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Navigation link functionality
            const navLinks = document.querySelectorAll('.nav-link');
            const contentSections = document.querySelectorAll('.content-section');

            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all links
                    navLinks.forEach(l => l.classList.remove('active'));
                    // Add active class to clicked link
                    this.classList.add('active');
                    
                    // Hide all content sections
                    contentSections.forEach(section => section.classList.remove('active'));
                    // Show the target section
                    const targetSection = document.getElementById(this.dataset.section);
                    if (targetSection) {
                        targetSection.classList.add('active');
                    }
                });
            });
        });

        // Updated dark mode implementation for sidebar layout
        function toggleDarkMode() {
            const theme = document.getElementById('theme-style');
            if (theme.getAttribute('data-dark') === '1') {
                // Light mode
                theme.innerHTML = `
                    body {
                        background: #f8f9fa;
                        margin: 0;
                        padding: 0;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    }
                    
                    .sidebar {
                        position: fixed;
                        top: 0;
                        left: 0;
                        height: 100vh;
                        width: 250px;
                        background: #2c3e50;
                        color: white;
                        z-index: 1000;
                        transition: all 0.3s ease;
                    }
                    
                    .sidebar-header {
                        padding: 1rem;
                        border-bottom: 1px solid #34495e;
                        display: flex;
                        align-items: center;
                    }
                    
                    .sidebar-header .logo {
                        height: 32px;
                        margin-right: 10px;
                    }
                    
                    .sidebar-header h4 {
                        margin: 0;
                        font-size: 1.1rem;
                        font-weight: 600;
                    }
                    
                    .sidebar-menu {
                        padding: 0;
                        margin: 0;
                        list-style: none;
                    }
                    
                    .sidebar-menu li {
                        border-bottom: 1px solid #34495e;
                    }
                    
                    .sidebar-menu a {
                        display: block;
                        padding: 12px 20px;
                        color: #bdc3c7;
                        text-decoration: none;
                        transition: all 0.3s ease;
                    }
                    
                    .sidebar-menu a:hover, .sidebar-menu a.active {
                        background: #34495e;
                        color: #3498db;
                        padding-left: 30px;
                    }
                    
                    .sidebar-menu i {
                        margin-right: 10px;
                        width: 18px;
                    }
                    
                    .main-content {
                        margin-left: 250px;
                        min-height: 100vh;
                        transition: all 0.3s ease;
                    }
                    
                    .content-header {
                        background: white;
                        padding: 1rem 2rem;
                        border-bottom: 1px solid #dee2e6;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    
                    .content-header .d-flex {
                        align-items: center;
                        justify-content: space-between;
                    }
                    
                    .page-content {
                        padding: 2rem;
                    }
                    
                    .content-section {
                        display: none;
                    }
                    
                    .content-section.active {
                        display: block;
                    }
                    
                    .card { 
                        border-radius: 10px; 
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        border: none;
                    }
                    
                    .card-header {
                        background: #3498db;
                        color: white;
                        border-radius: 10px 10px 0 0 !important;
                        padding: 1rem 1.5rem;
                        font-weight: 600;
                    }
                    
                    .table-striped>tbody>tr:hover { 
                        background-color: #f8f9fa; 
                        transition: background .2s; 
                    }
                    
                    .welcome { 
                        font-size: 1.2rem; 
                        font-weight: bold; 
                        color: #2c3e50; 
                    }
                    
                    .btn-primary {
                        background: #3498db;
                        border-color: #3498db;
                    }
                    
                    .btn-primary:hover {
                        background: #2980b9;
                        border-color: #2980b9;
                    }
                    
                    .btn-darkmode { 
                        margin-left: 10px; 
                    }
                    
                    @media (max-width: 768px) {
                        .sidebar {
                            transform: translateX(-100%);
                        }
                        
                        .sidebar.show {
                            transform: translateX(0);
                        }
                        
                        .main-content {
                            margin-left: 0;
                        }
                    }
                `;
                theme.setAttribute('data-dark', '0');
                localStorage.setItem('darkmode', '0');
            } else {
                // Dark mode
                theme.innerHTML = `
                    body {
                        background: #1a1a1a;
                        margin: 0;
                        padding: 0;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        color: #eee;
                    }
                    
                    .sidebar {
                        position: fixed;
                        top: 0;
                        left: 0;
                        height: 100vh;
                        width: 250px;
                        background: #1e2832;
                        color: white;
                        z-index: 1000;
                        transition: all 0.3s ease;
                    }
                    
                    .sidebar-header {
                        padding: 1rem;
                        border-bottom: 1px solid #2a3441;
                        display: flex;
                        align-items: center;
                    }
                    
                    .sidebar-header .logo {
                        height: 32px;
                        margin-right: 10px;
                    }
                    
                    .sidebar-header h4 {
                        margin: 0;
                        font-size: 1.1rem;
                        font-weight: 600;
                    }
                    
                    .sidebar-menu {
                        padding: 0;
                        margin: 0;
                        list-style: none;
                    }
                    
                    .sidebar-menu li {
                        border-bottom: 1px solid #2a3441;
                    }
                    
                    .sidebar-menu a {
                        display: block;
                        padding: 12px 20px;
                        color: #bdc3c7;
                        text-decoration: none;
                        transition: all 0.3s ease;
                    }
                    
                    .sidebar-menu a:hover, .sidebar-menu a.active {
                        background: #2a3441;
                        color: #ffc107;
                        padding-left: 30px;
                    }
                    
                    .sidebar-menu i {
                        margin-right: 10px;
                        width: 18px;
                    }
                    
                    .main-content {
                        margin-left: 250px;
                        min-height: 100vh;
                        transition: all 0.3s ease;
                    }
                    
                    .content-header {
                        background: #23272f;
                        padding: 1rem 2rem;
                        border-bottom: 1px solid #333;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    }
                    
                    .content-header .d-flex {
                        align-items: center;
                        justify-content: space-between;
                    }
                    
                    .page-content {
                        padding: 2rem;
                    }
                    
                    .content-section {
                        display: none;
                    }
                    
                    .content-section.active {
                        display: block;
                    }
                    
                    .card { 
                        border-radius: 10px; 
                        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                        border: none;
                        background: #23272f;
                        color: #eee;
                    }
                    
                    .card-header {
                        background: #ffc107;
                        color: #000;
                        border-radius: 10px 10px 0 0 !important;
                        padding: 1rem 1.5rem;
                        font-weight: 600;
                    }
                    
                    .table-striped>tbody>tr:hover { 
                        background-color: #2e3542 !important; 
                        transition: background .2s; 
                    }
                    
                    .welcome { 
                        font-size: 1.2rem; 
                        font-weight: bold; 
                        color: #ffc107; 
                    }
                    
                    .btn-primary {
                        background: #ffc107;
                        border-color: #ffc107;
                        color: #000;
                    }
                    
                    .btn-primary:hover {
                        background: #e0a800;
                        border-color: #e0a800;
                    }
                    
                    .btn, .form-control { 
                        background: #292c35; 
                        color: #eee; 
                        border-color: #333; 
                    }
                    
                    .btn-darkmode { 
                        margin-left: 10px; 
                    }
                    
                    @media (max-width: 768px) {
                        .sidebar {
                            transform: translateX(-100%);
                        }
                        
                        .sidebar.show {
                            transform: translateX(0);
                        }
                        
                        .main-content {
                            margin-left: 0;
                        }
                    }
                `;
                theme.setAttribute('data-dark', '1');
                localStorage.setItem('darkmode', '1');
            }
        }

        // Auto-load dark mode
        window.onload = function() {
            if (localStorage.getItem('darkmode') === '1') {
                toggleDarkMode();
            }
        }

        // Export accounts
        function exportAccounts() {
            fetch("/export_accounts")
            .then(r => r.json())
            .then(data => {
                const url = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], {type: "application/json"}));
                const a = document.createElement("a");
                a.href = url;
                a.download = "accounts.json";
                a.click();
                URL.revokeObjectURL(url);
            });
        }

        // Import accounts
        function importAccounts(input) {
            if (input.files.length == 0) return;
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                fetch("/import_accounts", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: e.target.result
                }).then(r => r.json())
                .then(data => {
                    if (data.success) location.reload();
                    else alert("导入失败：" + data.error);
                });
            }
            reader.readAsText(file);
        }

        // Batch delete
        function deleteSelected() {
            const checked = Array.from(document.querySelectorAll('input[name="selected_users"]:checked')).map(e => e.value);
            if (checked.length == 0) { alert("请选择需要删除的账号"); return; }
            if (!confirm("确认删除选中的账号？")) return;
            fetch("/batch_delete", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({users: checked})
            }).then(r => r.json())
            .then(data => {
                if (data.success) location.reload();
                else alert("批量删除失败：" + data.error);
            });
        }

        // Select all toggle
        function toggleSelectAll(box) {
            document.querySelectorAll('input[name="selected_users"]').forEach(e => {
                e.checked = box.checked;
            });
        }

        // Test account connection
        function testAccount(user, btn) {
            btn.disabled = true;
            btn.textContent = "测试中...";
            fetch("/test_account", {
                method: "POST",
                headers: {"Content-Type": "application/x-www-form-urlencoded"},
                body: "user=" + encodeURIComponent(user)
            })
            .then(r => r.json())
            .then(data => {
                btn.disabled = false;
                btn.textContent = "测试连接";
                var resultDiv = document.getElementById("test-result");
                resultDiv.style.display = "block";
                if (data.result.indexOf("成功") !== -1) {
                    resultDiv.className = "alert alert-success mt-2";
                } else {
                    resultDiv.className = "alert alert-danger mt-2";
                }
                resultDiv.textContent = user + "：" + data.result;
                setTimeout(() => { resultDiv.style.display = "none"; }, 5000);
            })
            .catch(() => {
                btn.disabled = false;
                btn.textContent = "测试连接";
                var resultDiv = document.getElementById("test-result");
                resultDiv.className = "alert alert-danger mt-2";
                resultDiv.textContent = "测试失败，请重试！";
                resultDiv.style.display = "block";
                setTimeout(() => { resultDiv.style.display = "none"; }, 5000);
            });
        }

        // 端口建议功能
        function updatePortSuggestion() {
            const protocol = document.getElementById('protocol-select').value;
            const ssl = document.getElementById('ssl-checkbox').checked;
            const portInput = document.getElementById('port-input');
            const suggestion = document.getElementById('port-suggestion');
            
            let recommendedPort;
            if (protocol === 'IMAP') {
                recommendedPort = ssl ? '993' : '143';
            } else { // POP3
                recommendedPort = ssl ? '995' : '110';
            }
            
            suggestion.textContent = `推荐端口: ${recommendedPort}`;
            
            // 如果端口输入框为空，自动填入推荐端口
            if (!portInput.value) {
                portInput.placeholder = recommendedPort;
            }
        }

        // 页面加载时初始化端口建议
        document.addEventListener('DOMContentLoaded', function() {
            updatePortSuggestion();
            // 如果当前在代理池页面，加载代理列表
            if (window.location.hash === '#proxy-pool' || document.querySelector('.nav-link[data-section="proxy-pool"]').classList.contains('active')) {
                loadProxyList();
            }
        });

        // 代理池管理功能
        function loadProxyList() {
            fetch('/proxies')
            .then(r => r.json())
            .then(data => {
                const tbody = document.getElementById('proxy-list');
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暂无代理，请先添加</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(proxy => `
                    <tr>
                        <td>
                            <input type="checkbox" name="selected_proxies" value="${proxy.id}">
                        </td>
                        <td>${proxy.name}</td>
                        <td>
                            <span class="badge bg-${proxy.type === 'SOCKS5' ? 'primary' : proxy.type === 'HTTP' ? 'success' : 'info'}">
                                ${proxy.type}
                            </span>
                        </td>
                        <td>${proxy.host}</td>
                        <td>${proxy.port}</td>
                        <td>
                            <span class="badge bg-${proxy.status === 'active' ? 'success' : 'secondary'}">
                                ${proxy.status === 'active' ? '可用' : '禁用'}
                            </span>
                        </td>
                        <td>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="testProxy(${proxy.id}, this)">测试</button>
                            <button type="button" class="btn btn-danger btn-sm ms-1" onclick="deleteProxy(${proxy.id})">删除</button>
                        </td>
                    </tr>
                `).join('');
            })
            .catch(err => {
                console.error('加载代理列表失败:', err);
                document.getElementById('proxy-list').innerHTML = '<tr><td colspan="7" class="text-center text-danger">加载失败，请刷新重试</td></tr>';
            });
        }

        function showAddProxyModal() {
            // 简单显示模态框（不使用Bootstrap JS）
            const modal = document.getElementById('addProxyModal');
            modal.style.display = 'block';
            modal.classList.add('show');
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
        }

        function hideAddProxyModal() {
            const modal = document.getElementById('addProxyModal');
            modal.style.display = 'none';
            modal.classList.remove('show');
        }

        function addProxy() {
            const form = document.getElementById('addProxyForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            fetch('/proxies', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // 关闭模态框
                    hideAddProxyModal();
                    // 清空表单
                    form.reset();
                    // 刷新列表
                    loadProxyList();
                    // 显示成功消息
                    showMessage('success', data.message || '代理添加成功');
                } else {
                    showMessage('danger', data.error || '添加失败');
                }
            })
            .catch(err => {
                console.error('添加代理失败:', err);
                showMessage('danger', '网络错误，请重试');
            });
        }

        function deleteProxy(proxyId) {
            if (!confirm('确认删除该代理？')) return;
            
            fetch(`/proxies/${proxyId}`, {
                method: 'DELETE'
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    loadProxyList();
                    showMessage('success', data.message || '代理删除成功');
                } else {
                    showMessage('danger', data.error || '删除失败');
                }
            })
            .catch(err => {
                console.error('删除代理失败:', err);
                showMessage('danger', '网络错误，请重试');
            });
        }

        function testProxy(proxyId, btn) {
            btn.disabled = true;
            btn.textContent = '测试中...';
            
            fetch(`/proxies/${proxyId}/test`, {
                method: 'POST'
            })
            .then(r => r.json())
            .then(data => {
                btn.disabled = false;
                btn.textContent = '测试';
                showMessage(data.success ? 'success' : 'danger', data.message || data.error);
            })
            .catch(err => {
                btn.disabled = false;
                btn.textContent = '测试';
                console.error('测试代理失败:', err);
                showMessage('danger', '测试失败，请重试');
            });
        }

        function deleteSelectedProxies() {
            const checked = Array.from(document.querySelectorAll('input[name="selected_proxies"]:checked')).map(e => parseInt(e.value));
            if (checked.length === 0) { 
                alert('请选择需要删除的代理'); 
                return; 
            }
            if (!confirm('确认删除选中的代理？')) return;
            
            fetch('/proxies/batch_delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ids: checked})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    loadProxyList();
                    showMessage('success', data.message || '批量删除成功');
                } else {
                    showMessage('danger', data.error || '删除失败');
                }
            })
            .catch(err => {
                console.error('批量删除失败:', err);
                showMessage('danger', '网络错误，请重试');
            });
        }

        function toggleSelectAllProxies(box) {
            document.querySelectorAll('input[name="selected_proxies"]').forEach(e => {
                e.checked = box.checked;
            });
        }

        function refreshProxyList() {
            loadProxyList();
            showMessage('info', '代理列表已刷新');
        }

        function showMessage(type, message) {
            // 创建或更新消息提示
            let alertDiv = document.getElementById('proxy-alert');
            if (!alertDiv) {
                alertDiv = document.createElement('div');
                alertDiv.id = 'proxy-alert';
                alertDiv.className = 'alert alert-dismissible fade show';
                alertDiv.style.position = 'fixed';
                alertDiv.style.top = '20px';
                alertDiv.style.right = '20px';
                alertDiv.style.zIndex = '1060';
                alertDiv.style.minWidth = '300px';
                document.body.appendChild(alertDiv);
            }
            
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // 3秒后自动消失
            setTimeout(() => {
                if (alertDiv && alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // 更新导航功能以支持代理列表加载
        document.addEventListener('DOMContentLoaded', function() {
            // 原有的导航功能
            const navLinks = document.querySelectorAll('.nav-link');
            const contentSections = document.querySelectorAll('.content-section');

            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    contentSections.forEach(section => section.classList.remove('active'));
                    const targetSection = document.getElementById(this.dataset.section);
                    if (targetSection) {
                        targetSection.classList.add('active');
                        
                        // 如果切换到代理池页面，加载代理列表
                        if (this.dataset.section === 'proxy-pool') {
                            loadProxyList();
                        }
                    }
                });
            });
            
            updatePortSuggestion();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
