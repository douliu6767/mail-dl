<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>邮箱账号管理后台</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style id="theme-style">
        body {
            background: #f8f9fa;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 250px;
            background: #2c3e50;
            color: white;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid #34495e;
            display: flex;
            align-items: center;
        }
        
        .sidebar-header .logo {
            height: 32px;
            margin-right: 10px;
        }
        
        .sidebar-header h4 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .sidebar-menu {
            padding: 0;
            margin: 0;
            list-style: none;
        }
        
        .sidebar-menu li {
            border-bottom: 1px solid #34495e;
        }
        
        .sidebar-menu a {
            display: block;
            padding: 12px 20px;
            color: #bdc3c7;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: #34495e;
            color: #3498db;
            padding-left: 30px;
        }
        
        .sidebar-menu i {
            margin-right: 10px;
            width: 18px;
        }
        
        /* Main Content Styles */
        .main-content {
            margin-left: 250px;
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        
        .content-header {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .content-header .d-flex {
            align-items: center;
            justify-content: space-between;
        }
        
        .page-content {
            padding: 2rem;
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        /* Card and Table Styles */
        .card { 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: none;
        }
        
        .card-header {
            background: #3498db;
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 1rem 1.5rem;
            font-weight: 600;
        }
        
        .table-striped>tbody>tr:hover { 
            background-color: #f8f9fa; 
            transition: background .2s; 
        }
        
        .welcome { 
            font-size: 1.2rem; 
            font-weight: bold; 
            color: #2c3e50; 
        }
        
        .btn-primary {
            background: #3498db;
            border-color: #3498db;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            border-color: #2980b9;
        }
        
        /* Dark Mode Toggle */
        .btn-darkmode { 
            margin-left: 10px; 
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="sidebar-header">
            <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" class="logo" alt="LOGO">
            <h4>管理后台</h4>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" data-section="dashboard" class="nav-link active"><i class="bi bi-house"></i>首页</a></li>
            <li><a href="#" data-section="email-management" class="nav-link"><i class="bi bi-envelope"></i>邮箱管理</a></li>
            <li><a href="#" data-section="card-management" class="nav-link"><i class="bi bi-credit-card"></i>卡密管理</a></li>
            <li><a href="#" data-section="proxy-pool" class="nav-link"><i class="bi bi-globe"></i>代理池</a></li>
            <li><a href="#" data-section="inbox-logs" class="nav-link"><i class="bi bi-list-ul"></i>收件日志</a></li>
            <li><a href="#" data-section="card-logs" class="nav-link"><i class="bi bi-journal-text"></i>卡密日志</a></li>
            <li><a href="#" data-section="system-settings" class="nav-link"><i class="bi bi-gear"></i>系统设置</a></li>
        </ul>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Header -->
        <div class="content-header">
            <div class="d-flex">
                <div>
                    <span class="welcome">欢迎使用邮箱账号管理后台</span>
                </div>
                <div>
                    <span class="me-2 text-success">管理员：{{ username }}</span>
                    <a href="/logout" class="btn btn-outline-secondary btn-sm">退出登录</a>
                    <button type="button" class="btn btn-dark btn-sm btn-darkmode" onclick="toggleDarkMode()">暗色模式</button>
                </div>
            </div>
        </div>

        <!-- Page Content -->
        <div class="page-content">
            {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
            {% endif %}
            {% if success %}
            <div class="alert alert-success">{{ success }}</div>
            {% endif %}

            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <div class="row">
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="bi bi-envelope h2 text-primary"></i>
                                <h5>邮箱账号</h5>
                                <h3 class="text-primary">{{ accounts|length }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="bi bi-credit-card h2 text-success"></i>
                                <h5>卡密总数</h5>
                                <h3 class="text-success">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="bi bi-globe h2 text-info"></i>
                                <h5>代理节点</h5>
                                <h3 class="text-info">{{ proxy_count or 0 }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="bi bi-list-ul h2 text-warning"></i>
                                <h5>今日日志</h5>
                                <h3 class="text-warning">0</h3>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-speedometer2"></i> 系统概览
                    </div>
                    <div class="card-body">
                        <p>欢迎使用邮箱账号管理后台系统！</p>
                        <p>您可以通过左侧导航栏访问各种功能模块：</p>
                        <ul>
                            <li><strong>邮箱管理</strong>：管理IMAP邮箱账号，包括添加、删除、测试连接等功能</li>
                            <li><strong>卡密管理</strong>：管理系统卡密（即将推出）</li>
                            <li><strong>代理池</strong>：管理代理服务器池（即将推出）</li>
                            <li><strong>收件日志</strong>：查看邮件收取日志（即将推出）</li>
                            <li><strong>卡密日志</strong>：查看卡密使用日志（即将推出）</li>
                            <li><strong>系统设置</strong>：配置系统参数（即将推出）</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Email Management Section -->
            <div id="email-management" class="content-section">
                <!-- 导入导出操作 -->
                <div class="mb-3">
                    <button type="button" class="btn btn-success me-2" onclick="exportAccounts()">导出账号</button>
                    <div class="d-inline-block me-2">
                        <label class="btn btn-info">
                            导入账号 <input type="file" style="display:none;" accept=".json" onchange="importAccounts(this)">
                        </label>
                    </div>
                    <button type="button" class="btn btn-danger" onclick="deleteSelected()">批量删除</button>
                </div>

                <!-- 添加邮箱账号表单 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-plus-circle"></i> 添加新邮箱账号
                    </div>
                    <div class="card-body">
                        <form method="post" action="/admin">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">备注名称</label>
                                    <input type="text" name="name" class="form-control" placeholder="可选备注名称" value="{{ request.form.name or '' }}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">邮箱地址 *</label>
                                    <input type="email" name="user" class="form-control" placeholder="example@domain.com" required value="{{ request.form.user or '' }}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">邮箱密码 *</label>
                                    <input type="password" name="password" class="form-control" placeholder="邮箱密码或授权码" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">服务器地址 *</label>
                                    <input type="text" name="host" class="form-control" placeholder="mail.example.com" required value="{{ request.form.host or '' }}">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">协议类型 *</label>
                                    <select name="protocol" class="form-select" id="protocol-select" onchange="updatePortSuggestion()">
                                        <option value="IMAP" {{ 'selected' if request.form.protocol == 'IMAP' else '' }}>IMAP</option>
                                        <option value="POP3" {{ 'selected' if request.form.protocol == 'POP3' else '' }}>POP3</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">端口号</label>
                                    <input type="number" name="port" class="form-control" id="port-input" placeholder="自动推荐" value="{{ request.form.port or '' }}">
                                    <div class="form-text" id="port-suggestion">推荐端口: 993</div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">安全连接</label>
                                    <div class="form-check mt-2">
                                        <input type="checkbox" name="ssl" class="form-check-input" id="ssl-checkbox" onchange="updatePortSuggestion()" checked>
                                        <label class="form-check-label" for="ssl-checkbox">
                                            启用 SSL/TLS
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3 d-grid align-self-end">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-plus-circle"></i> 添加账号
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 已添加邮箱账号列表 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-envelope-check"></i> 已添加邮箱账号
                    </div>
                    <div class="card-body">
                        <form id="batch-form" method="post" action="/batch_delete">
                        <table class="table table-striped align-middle">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="check-all" onclick="toggleSelectAll(this)"></th>
                                    <th>备注</th>
                                    <th>邮箱地址</th>
                                    <th>服务器</th>
                                    <th>协议</th>
                                    <th>端口</th>
                                    <th>SSL</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for acc in accounts %}
                                <tr>
                                    <td>
                                        <input type="checkbox" name="selected_users" value="{{ acc.user }}">
                                    </td>
                                    <td>{{ acc.name or '-' }}</td>
                                    <td>{{ acc.user }}</td>
                                    <td>{{ acc.host }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'primary' if acc.get('protocol', 'IMAP') == 'IMAP' else 'info' }}">
                                            {{ acc.get('protocol', 'IMAP') }}
                                        </span>
                                    </td>
                                    <td>{{ acc.get('port', '993' if acc.get('ssl', True) else '143') }}</td>
                                    <td>
                                        {% if acc.get('ssl', True) %}
                                            <i class="bi bi-shield-check text-success" title="SSL启用"></i>
                                        {% else %}
                                            <i class="bi bi-shield-x text-warning" title="SSL未启用"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <form method="post" action="/del_account" style="display:inline;">
                                            <input type="hidden" name="user" value="{{ acc.user }}">
                                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('确认删除该账号？');">删除</button>
                                        </form>
                                        <button type="button" class="btn btn-outline-success btn-sm ms-1" onclick="testAccount('{{ acc.user }}', this)">测试连接</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        </form>
                        {% if accounts|length == 0 %}
                        <div class="text-muted">暂无账号，请先添加。</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Other sections for future features -->
            <div id="card-management" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-credit-card"></i> 卡密管理
                    </div>
                    <div class="card-body">
                        <div class="text-center py-5">
                            <i class="bi bi-credit-card display-1 text-muted"></i>
                            <h4 class="mt-3">卡密管理功能</h4>
                            <p class="text-muted">此功能正在开发中，敬请期待...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="proxy-pool" class="content-section">
                <!-- 添加代理表单 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-plus-circle"></i> 添加新代理
                    </div>
                    <div class="card-body">
                        <form id="proxy-form">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">代理名称 *</label>
                                    <input type="text" id="proxy-name" class="form-control" placeholder="代理服务器名称" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">服务器地址 *</label>
                                    <input type="text" id="proxy-host" class="form-control" placeholder="127.0.0.1 或 proxy.example.com" required>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">端口 *</label>
                                    <input type="number" id="proxy-port" class="form-control" placeholder="8080" required min="1" max="65535">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">协议类型 *</label>
                                    <select id="proxy-protocol" class="form-select">
                                        <option value="HTTP">HTTP</option>
                                        <option value="SOCKS5">SOCKS5</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">用户名</label>
                                    <input type="text" id="proxy-username" class="form-control" placeholder="可选">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">密码</label>
                                    <input type="password" id="proxy-password" class="form-control" placeholder="可选">
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary me-2">
                                        <i class="bi bi-plus-circle"></i> 添加代理
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="resetProxyForm()">
                                        <i class="bi bi-arrow-clockwise"></i> 重置表单
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 代理列表 -->
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-globe"></i> 代理池管理</span>
                            <button type="button" class="btn btn-outline-light btn-sm" onclick="refreshProxyList()">
                                <i class="bi bi-arrow-clockwise"></i> 刷新
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="proxy-list">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="inbox-logs" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-list-ul"></i> 收件日志
                    </div>
                    <div class="card-body">
                        <div class="text-center py-5">
                            <i class="bi bi-list-ul display-1 text-muted"></i>
                            <h4 class="mt-3">收件日志功能</h4>
                            <p class="text-muted">此功能正在开发中，敬请期待...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="card-logs" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-journal-text"></i> 卡密日志
                    </div>
                    <div class="card-body">
                        <div class="text-center py-5">
                            <i class="bi bi-journal-text display-1 text-muted"></i>
                            <h4 class="mt-3">卡密日志功能</h4>
                            <p class="text-muted">此功能正在开发中，敬请期待...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="system-settings" class="content-section">
                <!-- Logo 管理 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-image"></i> Logo 管理
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6>自定义 Logo 上传</h6>
                                <p class="text-muted">支持 PNG、JPG、JPEG 格式，建议尺寸为 120x120 像素，文件大小不超过 2MB</p>
                                <form id="logo-upload-form" enctype="multipart/form-data">
                                    <div class="input-group mb-3">
                                        <input type="file" class="form-control" id="logo-file" accept=".png,.jpg,.jpeg,.gif" required>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-upload"></i> 上传 Logo
                                        </button>
                                    </div>
                                </form>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="resetLogo()">
                                    <i class="bi bi-arrow-clockwise"></i> 恢复默认 Logo
                                </button>
                            </div>
                            <div class="col-md-4 text-center">
                                <h6>当前 Logo 预览</h6>
                                <div class="border rounded p-3 bg-light">
                                    <img id="logo-preview" src="/static/logo.png" alt="当前Logo" style="max-width: 120px; max-height: 120px; border-radius: 10px;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 其他系统设置 -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-gear"></i> 其他设置
                    </div>
                    <div class="card-body">
                        <div class="text-center py-3">
                            <i class="bi bi-gear display-4 text-muted"></i>
                            <h5 class="mt-3">更多系统设置</h5>
                            <p class="text-muted">其他系统配置功能正在开发中...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="test-result" style="display:none;" class="alert mt-2"></div>
        </div>
    </div>

    <script>
        // Navigation functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Navigation link functionality
            const navLinks = document.querySelectorAll('.nav-link');
            const contentSections = document.querySelectorAll('.content-section');

            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all links
                    navLinks.forEach(l => l.classList.remove('active'));
                    // Add active class to clicked link
                    this.classList.add('active');
                    
                    // Hide all content sections
                    contentSections.forEach(section => section.classList.remove('active'));
                    // Show the target section
                    const targetSection = document.getElementById(this.dataset.section);
                    if (targetSection) {
                        targetSection.classList.add('active');
                    }
                });
            });
        });

        // Updated dark mode implementation for sidebar layout
        function toggleDarkMode() {
            const theme = document.getElementById('theme-style');
            if (theme.getAttribute('data-dark') === '1') {
                // Light mode
                theme.innerHTML = `
                    body {
                        background: #f8f9fa;
                        margin: 0;
                        padding: 0;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    }
                    
                    .sidebar {
                        position: fixed;
                        top: 0;
                        left: 0;
                        height: 100vh;
                        width: 250px;
                        background: #2c3e50;
                        color: white;
                        z-index: 1000;
                        transition: all 0.3s ease;
                    }
                    
                    .sidebar-header {
                        padding: 1rem;
                        border-bottom: 1px solid #34495e;
                        display: flex;
                        align-items: center;
                    }
                    
                    .sidebar-header .logo {
                        height: 32px;
                        margin-right: 10px;
                    }
                    
                    .sidebar-header h4 {
                        margin: 0;
                        font-size: 1.1rem;
                        font-weight: 600;
                    }
                    
                    .sidebar-menu {
                        padding: 0;
                        margin: 0;
                        list-style: none;
                    }
                    
                    .sidebar-menu li {
                        border-bottom: 1px solid #34495e;
                    }
                    
                    .sidebar-menu a {
                        display: block;
                        padding: 12px 20px;
                        color: #bdc3c7;
                        text-decoration: none;
                        transition: all 0.3s ease;
                    }
                    
                    .sidebar-menu a:hover, .sidebar-menu a.active {
                        background: #34495e;
                        color: #3498db;
                        padding-left: 30px;
                    }
                    
                    .sidebar-menu i {
                        margin-right: 10px;
                        width: 18px;
                    }
                    
                    .main-content {
                        margin-left: 250px;
                        min-height: 100vh;
                        transition: all 0.3s ease;
                    }
                    
                    .content-header {
                        background: white;
                        padding: 1rem 2rem;
                        border-bottom: 1px solid #dee2e6;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    
                    .content-header .d-flex {
                        align-items: center;
                        justify-content: space-between;
                    }
                    
                    .page-content {
                        padding: 2rem;
                    }
                    
                    .content-section {
                        display: none;
                    }
                    
                    .content-section.active {
                        display: block;
                    }
                    
                    .card { 
                        border-radius: 10px; 
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        border: none;
                    }
                    
                    .card-header {
                        background: #3498db;
                        color: white;
                        border-radius: 10px 10px 0 0 !important;
                        padding: 1rem 1.5rem;
                        font-weight: 600;
                    }
                    
                    .table-striped>tbody>tr:hover { 
                        background-color: #f8f9fa; 
                        transition: background .2s; 
                    }
                    
                    .welcome { 
                        font-size: 1.2rem; 
                        font-weight: bold; 
                        color: #2c3e50; 
                    }
                    
                    .btn-primary {
                        background: #3498db;
                        border-color: #3498db;
                    }
                    
                    .btn-primary:hover {
                        background: #2980b9;
                        border-color: #2980b9;
                    }
                    
                    .btn-darkmode { 
                        margin-left: 10px; 
                    }
                    
                    @media (max-width: 768px) {
                        .sidebar {
                            transform: translateX(-100%);
                        }
                        
                        .sidebar.show {
                            transform: translateX(0);
                        }
                        
                        .main-content {
                            margin-left: 0;
                        }
                    }
                `;
                theme.setAttribute('data-dark', '0');
                localStorage.setItem('darkmode', '0');
            } else {
                // Dark mode
                theme.innerHTML = `
                    body {
                        background: #1a1a1a;
                        margin: 0;
                        padding: 0;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        color: #eee;
                    }
                    
                    .sidebar {
                        position: fixed;
                        top: 0;
                        left: 0;
                        height: 100vh;
                        width: 250px;
                        background: #1e2832;
                        color: white;
                        z-index: 1000;
                        transition: all 0.3s ease;
                    }
                    
                    .sidebar-header {
                        padding: 1rem;
                        border-bottom: 1px solid #2a3441;
                        display: flex;
                        align-items: center;
                    }
                    
                    .sidebar-header .logo {
                        height: 32px;
                        margin-right: 10px;
                    }
                    
                    .sidebar-header h4 {
                        margin: 0;
                        font-size: 1.1rem;
                        font-weight: 600;
                    }
                    
                    .sidebar-menu {
                        padding: 0;
                        margin: 0;
                        list-style: none;
                    }
                    
                    .sidebar-menu li {
                        border-bottom: 1px solid #2a3441;
                    }
                    
                    .sidebar-menu a {
                        display: block;
                        padding: 12px 20px;
                        color: #bdc3c7;
                        text-decoration: none;
                        transition: all 0.3s ease;
                    }
                    
                    .sidebar-menu a:hover, .sidebar-menu a.active {
                        background: #2a3441;
                        color: #ffc107;
                        padding-left: 30px;
                    }
                    
                    .sidebar-menu i {
                        margin-right: 10px;
                        width: 18px;
                    }
                    
                    .main-content {
                        margin-left: 250px;
                        min-height: 100vh;
                        transition: all 0.3s ease;
                    }
                    
                    .content-header {
                        background: #23272f;
                        padding: 1rem 2rem;
                        border-bottom: 1px solid #333;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    }
                    
                    .content-header .d-flex {
                        align-items: center;
                        justify-content: space-between;
                    }
                    
                    .page-content {
                        padding: 2rem;
                    }
                    
                    .content-section {
                        display: none;
                    }
                    
                    .content-section.active {
                        display: block;
                    }
                    
                    .card { 
                        border-radius: 10px; 
                        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                        border: none;
                        background: #23272f;
                        color: #eee;
                    }
                    
                    .card-header {
                        background: #ffc107;
                        color: #000;
                        border-radius: 10px 10px 0 0 !important;
                        padding: 1rem 1.5rem;
                        font-weight: 600;
                    }
                    
                    .table-striped>tbody>tr:hover { 
                        background-color: #2e3542 !important; 
                        transition: background .2s; 
                    }
                    
                    .welcome { 
                        font-size: 1.2rem; 
                        font-weight: bold; 
                        color: #ffc107; 
                    }
                    
                    .btn-primary {
                        background: #ffc107;
                        border-color: #ffc107;
                        color: #000;
                    }
                    
                    .btn-primary:hover {
                        background: #e0a800;
                        border-color: #e0a800;
                    }
                    
                    .btn, .form-control { 
                        background: #292c35; 
                        color: #eee; 
                        border-color: #333; 
                    }
                    
                    .btn-darkmode { 
                        margin-left: 10px; 
                    }
                    
                    @media (max-width: 768px) {
                        .sidebar {
                            transform: translateX(-100%);
                        }
                        
                        .sidebar.show {
                            transform: translateX(0);
                        }
                        
                        .main-content {
                            margin-left: 0;
                        }
                    }
                `;
                theme.setAttribute('data-dark', '1');
                localStorage.setItem('darkmode', '1');
            }
        }

        // Auto-load dark mode
        window.onload = function() {
            if (localStorage.getItem('darkmode') === '1') {
                toggleDarkMode();
            }
        }

        // Export accounts
        function exportAccounts() {
            fetch("/export_accounts")
            .then(r => r.json())
            .then(data => {
                const url = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], {type: "application/json"}));
                const a = document.createElement("a");
                a.href = url;
                a.download = "accounts.json";
                a.click();
                URL.revokeObjectURL(url);
            });
        }

        // Import accounts
        function importAccounts(input) {
            if (input.files.length == 0) return;
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                fetch("/import_accounts", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: e.target.result
                }).then(r => r.json())
                .then(data => {
                    if (data.success) location.reload();
                    else alert("导入失败：" + data.error);
                });
            }
            reader.readAsText(file);
        }

        // Batch delete
        function deleteSelected() {
            const checked = Array.from(document.querySelectorAll('input[name="selected_users"]:checked')).map(e => e.value);
            if (checked.length == 0) { alert("请选择需要删除的账号"); return; }
            if (!confirm("确认删除选中的账号？")) return;
            fetch("/batch_delete", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({users: checked})
            }).then(r => r.json())
            .then(data => {
                if (data.success) location.reload();
                else alert("批量删除失败：" + data.error);
            });
        }

        // Select all toggle
        function toggleSelectAll(box) {
            document.querySelectorAll('input[name="selected_users"]').forEach(e => {
                e.checked = box.checked;
            });
        }

        // Test account connection
        function testAccount(user, btn) {
            btn.disabled = true;
            btn.textContent = "测试中...";
            fetch("/test_account", {
                method: "POST",
                headers: {"Content-Type": "application/x-www-form-urlencoded"},
                body: "user=" + encodeURIComponent(user)
            })
            .then(r => r.json())
            .then(data => {
                btn.disabled = false;
                btn.textContent = "测试连接";
                var resultDiv = document.getElementById("test-result");
                resultDiv.style.display = "block";
                if (data.result.indexOf("成功") !== -1) {
                    resultDiv.className = "alert alert-success mt-2";
                } else {
                    resultDiv.className = "alert alert-danger mt-2";
                }
                resultDiv.textContent = user + "：" + data.result;
                setTimeout(() => { resultDiv.style.display = "none"; }, 5000);
            })
            .catch(() => {
                btn.disabled = false;
                btn.textContent = "测试连接";
                var resultDiv = document.getElementById("test-result");
                resultDiv.className = "alert alert-danger mt-2";
                resultDiv.textContent = "测试失败，请重试！";
                resultDiv.style.display = "block";
                setTimeout(() => { resultDiv.style.display = "none"; }, 5000);
            });
        }

        // 端口建议功能
        function updatePortSuggestion() {
            const protocol = document.getElementById('protocol-select').value;
            const ssl = document.getElementById('ssl-checkbox').checked;
            const portInput = document.getElementById('port-input');
            const suggestion = document.getElementById('port-suggestion');
            
            let recommendedPort;
            if (protocol === 'IMAP') {
                recommendedPort = ssl ? '993' : '143';
            } else { // POP3
                recommendedPort = ssl ? '995' : '110';
            }
            
            suggestion.textContent = `推荐端口: ${recommendedPort}`;
            
            // 如果端口输入框为空，自动填入推荐端口
            if (!portInput.value) {
                portInput.placeholder = recommendedPort;
            }
        }

        // 页面加载时初始化端口建议
        document.addEventListener('DOMContentLoaded', function() {
            updatePortSuggestion();
            
            // 初始化代理列表
            if (document.getElementById('proxy-list')) {
                refreshProxyList();
            }
            
            // 初始化logo预览
            loadLogoPreview();
            
            // 绑定代理表单提交事件
            const proxyForm = document.getElementById('proxy-form');
            if (proxyForm) {
                proxyForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    addProxy();
                });
            }
            
            // 绑定logo上传表单事件
            const logoForm = document.getElementById('logo-upload-form');
            if (logoForm) {
                logoForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    uploadLogo();
                });
            }
        });

        // Logo管理功能
        function loadLogoPreview() {
            fetch('/api/settings')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const logoPreview = document.getElementById('logo-preview');
                    if (logoPreview) {
                        logoPreview.src = '/static/' + data.data.custom_logo;
                    }
                }
            })
            .catch(err => console.error('加载logo预览失败:', err));
        }

        function uploadLogo() {
            const fileInput = document.getElementById('logo-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('请选择文件');
                return;
            }
            
            const formData = new FormData();
            formData.append('logo', file);
            
            fetch('/upload_logo', {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('Logo上传成功！');
                    loadLogoPreview();
                    fileInput.value = '';
                } else {
                    alert('上传失败：' + data.error);
                }
            })
            .catch(err => {
                alert('上传失败，请重试');
                console.error('Logo上传错误:', err);
            });
        }

        function resetLogo() {
            if (!confirm('确认要恢复默认Logo吗？')) return;
            
            fetch('/reset_logo', {
                method: 'POST'
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('已恢复默认Logo');
                    loadLogoPreview();
                } else {
                    alert('恢复失败：' + data.error);
                }
            })
            .catch(err => {
                alert('恢复失败，请重试');
                console.error('恢复Logo错误:', err);
            });
        }

        // 代理池管理功能
        function refreshProxyList() {
            const proxyListContainer = document.getElementById('proxy-list');
            if (!proxyListContainer) return;
            
            proxyListContainer.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">加载中...</span></div></div>';
            
            fetch('/api/proxy')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    renderProxyList(data.data);
                } else {
                    proxyListContainer.innerHTML = '<div class="alert alert-danger">加载失败：' + data.error + '</div>';
                }
            })
            .catch(err => {
                proxyListContainer.innerHTML = '<div class="alert alert-danger">加载失败，请重试</div>';
                console.error('加载代理列表错误:', err);
            });
        }

        function renderProxyList(proxies) {
            const proxyListContainer = document.getElementById('proxy-list');
            
            if (proxies.length === 0) {
                proxyListContainer.innerHTML = '<div class="text-muted text-center py-3">暂无代理，请添加代理服务器</div>';
                return;
            }
            
            let html = `
                <table class="table table-striped align-middle">
                    <thead>
                        <tr>
                            <th>名称</th>
                            <th>地址:端口</th>
                            <th>协议</th>
                            <th>认证</th>
                            <th>状态</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            proxies.forEach(proxy => {
                const hasAuth = proxy.username && proxy.password;
                const statusBadge = proxy.is_active ? 
                    '<span class="badge bg-success">启用</span>' : 
                    '<span class="badge bg-secondary">禁用</span>';
                const createdAt = new Date(proxy.created_at).toLocaleString('zh-CN');
                
                html += `
                    <tr>
                        <td>${proxy.name}</td>
                        <td>${proxy.host}:${proxy.port}</td>
                        <td><span class="badge bg-${proxy.protocol === 'HTTP' ? 'primary' : 'info'}">${proxy.protocol}</span></td>
                        <td>${hasAuth ? '<i class="bi bi-shield-check text-success" title="有认证"></i>' : '<i class="bi bi-shield-x text-muted" title="无认证"></i>'}</td>
                        <td>${statusBadge}</td>
                        <td>${createdAt}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editProxy(${proxy.id})" title="编辑">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-${proxy.is_active ? 'warning' : 'success'}" onclick="toggleProxy(${proxy.id})" title="${proxy.is_active ? '禁用' : '启用'}">
                                    <i class="bi bi-${proxy.is_active ? 'pause' : 'play'}"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteProxy(${proxy.id})" title="删除">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            proxyListContainer.innerHTML = html;
        }

        function addProxy() {
            const formData = {
                name: document.getElementById('proxy-name').value,
                host: document.getElementById('proxy-host').value,
                port: document.getElementById('proxy-port').value,
                protocol: document.getElementById('proxy-protocol').value,
                username: document.getElementById('proxy-username').value,
                password: document.getElementById('proxy-password').value
            };
            
            if (!formData.name || !formData.host || !formData.port) {
                alert('请填写必填字段');
                return;
            }
            
            fetch('/api/proxy', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(formData)
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('代理添加成功！');
                    resetProxyForm();
                    refreshProxyList();
                } else {
                    alert('添加失败：' + data.error);
                }
            })
            .catch(err => {
                alert('添加失败，请重试');
                console.error('添加代理错误:', err);
            });
        }

        function resetProxyForm() {
            document.getElementById('proxy-form').reset();
        }

        function editProxy(proxyId) {
            // 这里可以实现编辑功能，暂时用简单的提示
            alert('编辑功能正在开发中，敬请期待');
        }

        function toggleProxy(proxyId) {
            fetch(`/api/proxy/${proxyId}/toggle`, {
                method: 'POST'
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    refreshProxyList();
                } else {
                    alert('操作失败：' + data.error);
                }
            })
            .catch(err => {
                alert('操作失败，请重试');
                console.error('切换代理状态错误:', err);
            });
        }

        function deleteProxy(proxyId) {
            if (!confirm('确认删除该代理？')) return;
            
            fetch(`/api/proxy/${proxyId}`, {
                method: 'DELETE'
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('代理删除成功');
                    refreshProxyList();
                } else {
                    alert('删除失败：' + data.error);
                }
            })
            .catch(err => {
                alert('删除失败，请重试');
                console.error('删除代理错误:', err);
            });
        }
    </script>
</body>
</html>
